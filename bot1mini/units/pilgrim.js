import {BCAbstractRobot, SPECS} from 'battlecode';import search from '../search.js';import base from '../base.js';import qmath from '../math.js';import signal from '../signals.js';import pathing from '../pathing/pathing-bundled.js';function mind(e){var t=e.getFuelMap(),n=e.getKarboniteMap(),a=e.getVisibleRobotMap(),i=(e.me.team+1)%2,s="",r=e.map,o=e.map.length,l=null;if(e.globalTurn+=1,1===e.me.turn){e.searchQueue=[],e.lastWarCry=-100,e.miningIndex=-1,e.lastChainTurn=-1,e.statusBeforeReturn="",e.status="searchForKarbDeposit",e.status="waitingForCommand",e.onFrontLine=!1,e.firstTimeScouting=!0,e.frontLineScoutingTarget={x:0,y:0},e.occupiedHalf=null,e.castleTalk(e.me.unit);for(var u=0;u<o;u++)for(var g=0;g<o;g++)!0===t[u][g]&&(e.fuelSpots.push({x:g,y:u}),e.allSpots.push({x:g,y:u,type:"fuel"})),!0===n[u][g]&&(e.karboniteSpots.push({x:g,y:u}),e.allSpots.push({x:g,y:u,type:"karbonite"}));e.churchBuilt=!1,e.searchAny=!1,e.mapIsHorizontal=search.horizontalSymmetry(r);var m=e.initializeCastleLocations();m?(e.originalCastleLocation=[e.knownStructures[e.me.team][0].x,e.knownStructures[e.me.team][0].y],e.globalTurn=m.turn,29002===m.signal&&(e.status="frontLineScout",e.castleTalk(6)),e.globalTurn+=1):(e.status="searchForAnyDeposit",e.churchBuilt=!0,e.searchAny=!0),e.target=[e.me.x,e.me.y],e.finalTarget=[e.me.x,e.me.y],e.mapIsHorizontal?(e.halfPoint=o/2,e.me.y<o/2?e.lowerHalf=!0:e.lowerHalf=!1):(e.halfPoint=o/2,e.me.x<o/2?e.lowerHalf=!0:e.lowerHalf=!1)}5===e.me.turn&&(pathing.initializePlanner(e),e.setFinalTarget(e.finalTarget));var f=e.getVisibleRobots();for(u=0;u<f.length;u++)if(f[u].team===e.me.team){var c=f[u].signal,p=f[u].id;if(signal.processMessagePilgrim(e,c),c>=24586&&c<=28681&&"frontLineScout"!==e.status){e.status="goingToDeposit";var S=24586,h=e.getLocation(c-S);e.finalTarget=[h.x,h.y],e.miningIndex=getIndexAllSpots(e,e.finalTarget);var d=search.circle(e,e.finalTarget[0],e.finalTarget[1],2),x=0,T=null;for(u=0;u<d.length;u++){var y=d[u],C=e.getRobot(a[y[1]][y[0]]),b=numberOfDeposits(e,y[0],y[1],!0);null===C&&!1===t[y[1]][y[0]]&&!1===n[y[1]][y[0]]&&!0===r[y[1]][y[0]]&&x<b&&(x=b,T=y),9===b&&(T=y,x=b)}null!==T&&(e.status="building",e.buildTarget=T)}else if(c<28842&&c>=28682&&"waitingForCommand"===e.status&&-1===e.miningIndex&&"frontLineScout"!==e.status){var E=c-(S=28682);e.status="goingToDeposit",e.miningIndex=E,e.finalTarget=[e.allSpots[e.miningIndex].x,e.allSpots[e.miningIndex].y]}else if(c<29002&&c>=28842&&"waitingForCommand"===e.status&&"frontLineScout"!==e.status){E=c-(S=28842);e.status="goingToDeposit";var P=e.allSpots[e.miningIndex];P.type===e.allSpots[E].type&&0===qmath.dist(P.x,P.y,e.me.x,e.me.y)||(e.miningIndex=E),e.finalTarget=[e.allSpots[e.miningIndex].x,e.allSpots[e.miningIndex].y]}else if(c>=33099&&c<=41290){S=33099;c>=37195&&(S=37195);var H=e.getLocation(c-S);base.logStructure(e,H.x,H.y,i,0);var I=H.x,R=H.y;if(e.mapIsHorizontal?R=o-R-1:I=o-I-1,base.logStructure(e,I,R,e.me.team,0),e.enemyDirection=e.determineEnemyDirection(I,R),e.mapIsHorizontal?R<=o/2&&e.me.y>o/2?e.lowerHalf=!e.lowerHalf:R>=o/2&&e.me.y<o/2&&(e.lowerHalf=!e.lowerHalf):I<=o/2&&e.me.x>o/2?e.lowerHalf=!e.lowerHalf:I>=o/2&&e.me.x<o/2&&(e.lowerHalf=!e.lowerHalf),37195===S&&("frontLineScout"!==e.status&&(e.status="chainedPilgrim"),e.karbonite>400&&e.fuel>6100&&e.knownStructures[i].length)){var D=e.knownStructures[i][0].x,v=e.knownStructures[i][0].y,k=e.compressLocation(D,v),A=37195;(B=(M=search.circle(e,e.me.x,e.me.y,2)).map(function(e){return{pos:e,dist:qmath.dist(e[0],e[1],D,v)}})).sort(function(e,t){return e.dist-t.dist}),M=B.map(function(e){return e.pos});for(u=0;u<M.length;u++){if(canBuild(e,(z=M[u])[0],z[1],a,r)){var F=base.rel(e.me.x,e.me.y,z[0],z[1]);return e.signal(A+k,4),{action:e.buildUnit(SPECS.CHURCH,F.dx,F.dy)}}}}}else 41291===c&&p!==e.me.id&&("chainedPilgrim"===e.status&&(e.signal(41291,4),e.status="searchForAnyDeposit"),e.status)}if("waitingForCommand"===e.status?(e.status="goingToDeposit",1!==e.me.turn&&(e.finalTarget=[e.allSpots[e.miningIndex].x,e.allSpots[e.miningIndex].y]),e.status="searchForAnyDeposit"):"frontLineScout"===e.status&&e.firstTimeScouting&&(e.frontLineScoutingTarget=[e.knownStructures[i][0].x,e.knownStructures[i][0].y],e.finalTarget=e.frontLineScoutingTarget),"moveaway"===e.status)for(var w=search.circle(e,e.me.x,e.me.y,2),L=0;L<w.length;L++)w[L];"frontLineScout"===e.status&&e.me.turn>1&&(!0===e.onFrontLine?e.me.turn%3==0?e.castleTalk(71+e.me.y):e.me.turn%3==1?e.castleTalk(7+e.me.x):e.castleTalk(135):e.me.turn%2==0?e.castleTalk(71+e.me.y):e.castleTalk(7+e.me.x));var Q=search.unitsInRadius(e,64);"frontLineScout"===e.status&&Q[SPECS.PREACHER].length+Q[SPECS.CRUSADER].length>10&&e.me.turn-e.lastWarCry>10&&(e.lastWarCry=e.me.turn);var U=[];e.onFrontLine=!1;for(u=0;u<f.length;u++){var q=f[u];if(q.team===i){var K=qmath.dist(e.me.x,e.me.y,q.x,q.y);if((K>64&&q.unit!==SPECS.PREACHER||K>=36&&q.unit===SPECS.PREACHER)&&K<=100&&q.unit!==SPECS.PILGRIM)if(e.onFrontLine=!0,"frontLineScout"===e.status){if(e.finalTarget=[e.me.x,e.me.y],!0===e.onFrontLine&&e.knownStructures[i].length){D=e.knownStructures[i][0].x,v=e.knownStructures[i][0].y,k=e.compressLocation(D,v),A=37195;if(e.karbonite>=800&&e.fuel>=1e4&&e.lastChainTurn<e.me.turn-2&&Q[SPECS.PROPHET].length>6){var M,B;(B=(M=search.circle(e,e.me.x,e.me.y,2)).map(function(e){return{pos:e,dist:qmath.dist(e[0],e[1],D,v)}})).sort(function(e,t){return e.dist-t.dist}),M=B.map(function(e){return e.pos});for(u=0;u<M.length;u++){var z;if(null!==(C=a[(z=M[u])[1]][z[0]])&&C.unit===SPECS.CHURCH&&C.team===e.me.team){e.signal(A+k,4);break}if(canBuild(e,z[0],z[1],a,r)){F=base.rel(e.me.x,e.me.y,z[0],z[1]);return e.signal(A+k,4),e.lastChainTurn=e.me.turn,{action:e.buildUnit(SPECS.CHURCH,F.dx,F.dy)}}}}}}else l="";else e.status,q.unit===SPECS.PROPHET&&K<100?U.push([q.x,q.y,SPECS.PROPHET]):q.unit===SPECS.PREACHER&&K<=64?U.push([q.x,q.y,SPECS.PREACHER]):q.unit===SPECS.CRUSADER&&K<=64?U.push([q.x,q.y,SPECS.CRUSADER]):q.unit===SPECS.CHURCH&&K<80?U.push([q.x,q.y,SPECS.CHURCH]):q.unit===SPECS.CASTLE&&K<100&&U.push([q.x,q.y,SPECS.CASTLE])}}var O=[];if(U.length>0){var V=search.circle(e,e.me.x,e.me.y,4);for(u=0;u<V.length;u++){var G=0;y=V[u];if(search.emptyPos(y[0],y[1],a,e.map)){for(g=0;g<U.length;g++)G+=qmath.dist(y[0],y[1],U[g][0],U[g][1]);O.push({pos:y,dist:G})}}}if(O.length>0){O.sort(function(e,t){return t.dist-e.dist});F=base.rel(e.me.x,e.me.y,O[0].pos[0],O[0].pos[1]);"frontLineScout"!==e.status&&(e.status="searchForAnyDeposit");var N=!1;for(u=0;u<U.length;u++){var W=qmath.dist(O[0].pos[0],O[0].pos[1],U[u][0],U[u][1]);U[u][2]!==SPECS.PILGRIM&&(U[u][2]===SPECS.PREACHER?W<=36&&(N=!0):W<=64&&(N=!0))}if(!N)return{action:e.move(F.dx,F.dy)};l=""}if("goingToKarbDeposit"===e.status||"goingToFuelDeposit"===e.status||"goingToAnyDeposit"===e.status)if(a[e.finalTarget[1]][e.finalTarget[0]]!==e.me.id&&a[e.finalTarget[1]][e.finalTarget[0]]>0){if("goingToKarbDeposit"===e.status)if(e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77),0===e.searchQueue.length)e.status="searchForAnyDeposit";else{var j=e.searchQueue.pop().position;e.finalTarget=j,e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77)}else if("goingToFuelDeposit"===e.status)if(e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77),0===e.searchQueue.length)e.status="searchForAnyDeposit";else{j=e.searchQueue.pop().position;e.finalTarget=j,e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77)}else if(!0===e.churchBuilt||!0===e.searchAny||"goingToAnyDeposit"===e.status)if(0===e.searchQueue.length)e.status="searchForAnyDeposit";else{j=e.searchQueue.pop().position;e.finalTarget=j,e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77)}}else e.miningIndex=getIndexAllSpots(e,e.finalTarget),e.castleTalk(e.miningIndex+77);if("goingToDeposit"===e.status&&a[e.finalTarget[1]][e.finalTarget[0]]!==e.me.id&&a[e.finalTarget[1]][e.finalTarget[0]]>0&&qmath.dist(e.me.x,e.me.y,e.finalTarget[0],e.finalTarget[1])<=2&&(e.status="searchForAnyDeposit"),"searchForKarbDeposit"===e.status||"searchForFuelDeposit"===e.status){if("searchForFuelDeposit"===e.status){for(u=0;u<e.fuelSpots.length;u++){D=e.fuelSpots[u].x;if((a[v=e.fuelSpots[u].y][D]<=0||a[v][D]===e.me.id)&&safeDeposit(e,D,v)){var J=[],X=0;X=null!==e.planner?e.planner.search(e.me.y,e.me.x,v,D,J):qmath.dist(e.me.x,e.me.y,D,v),e.searchQueue.push({position:[D,v],distance:X})}}e.searchQueue.sort(function(e,t){return t.distance-e.distance}),e.searchQueue.length>0&&(e.status="goingToFuelDeposit",e.finalTarget=e.searchQueue.pop().position)}if("searchForKarbDeposit"===e.status){e.searchQueue=[];for(u=0;u<e.karboniteSpots.length;u++){D=e.karboniteSpots[u].x;if((a[v=e.karboniteSpots[u].y][D]<=0||a[v][D]===e.me.id)&&safeDeposit(e,D,v)){J=[],X=0;X=null!==e.planner?e.planner.search(e.me.y,e.me.x,v,D,J):qmath.dist(e.me.x,e.me.y,D,v),e.searchQueue.push({position:[D,v],distance:X})}}e.searchQueue.sort(function(e,t){return t.distance-e.distance}),e.searchQueue.length>0&&(e.status="goingToKarbDeposit",e.finalTarget=e.searchQueue.pop().position)}}if("searchForAnyDeposit"===e.status){e.searchQueue=[];for(u=0;u<e.fuelSpots.length;u++){D=e.fuelSpots[u].x;if((a[v=e.fuelSpots[u].y][D]<=0||a[v][D]===e.me.id)&&safeDeposit(e,D,v)){J=[],X=0;X=null!==e.planner?e.planner.search(e.me.y,e.me.x,v,D,J):qmath.dist(e.me.x,e.me.y,D,v),e.searchQueue.push({position:[D,v],distance:X})}}for(u=0;u<e.karboniteSpots.length;u++){D=e.karboniteSpots[u].x;if((a[v=e.karboniteSpots[u].y][D]<=0||a[v][D]===e.me.id)&&safeDeposit(e,D,v)){J=[],X=0;X=null!==e.planner?e.planner.search(e.me.y,e.me.x,v,D,J):qmath.dist(e.me.x,e.me.y,D,v),e.searchQueue.push({position:[D,v],distance:X})}}e.searchQueue.sort(function(e,t){return t.distance-e.distance}),e.searchQueue.length>0&&(e.finalTarget=e.searchQueue.pop().position,e.status="goingToAnyDeposit",e.miningIndex=getIndexAllSpots(e,e.finalTarget))}if(e.me.fuel>=100||e.me.karbonite>=20||"return"===e.status){var Y=search.findNearestStructure(e),Z=!0;if("building"===e.status&&qmath.dist(Y.x,Y.y,e.me.x,e.me.y)>100&&(Z=!1),Z){"mineKarb"!==e.status&&"mineFuel"!==e.status||(e.statusBeforeReturn=e.status),"mineKarb"===e.statusBeforeReturn||e.statusBeforeReturn,e.finalTarget=[Y.x,Y.y],e.status="return";var $=base.rel(e.me.x,e.me.y,e.finalTarget[0],e.finalTarget[1]);if(Math.abs($.dx)<=1&&Math.abs($.dy)<=1)return Y.unit===SPECS.CASTLE?(e.status="waitingForCommand",e.signal(4,2),e.castleTalk(0)):Y.unit===SPECS.CHURCH&&(e.status="goingToDeposit",e.finalTarget=[e.allSpots[e.miningIndex].x,e.allSpots[e.miningIndex].y]),s=e.give($.dx,$.dy,e.me.karbonite,e.me.fuel),{action:s}}}if("goingToDeposit"===e.status){d=search.circle(e,e.finalTarget[0],e.finalTarget[1],2);var _=!1;e.me.turn>1&&e.castleTalk(e.miningIndex+77);for(u=0;u<d.length;u++){y=d[u];(null===(C=e.getRobot(a[y[1]][y[0]]))||C.unit===SPECS.CHURCH&&C.unit===SPECS.CASTLE)&&null!==C||(_=!0)}1==_&&e.me.turn}if("mineKarb"===e.status||"mineFuel"===e.status){d=search.circle(e,e.me.x,e.me.y,2);var ee=search.findNearestStructure(e),te=qmath.dist(e.me.x,e.me.y,ee.x,ee.y),ne=4;if(e.globalTurn<=50&&(ne=10),te>ne){for(_=!0,u=0;u<d.length;u++){y=d[u];null===(C=e.getRobot(a[y[1]][y[0]]))||C.unit!==SPECS.CHURCH&&C.unit!==SPECS.CASTLE||(_=!1)}if(!0===_){for(x=0,T=null,u=0;u<d.length;u++){y=d[u],C=e.getRobot(a[y[1]][y[0]]),b=numberOfDeposits(e,y[0],y[1],!0);null===C&&!1===t[y[1]][y[0]]&&!1===n[y[1]][y[0]]&&!0===r[y[1]][y[0]]&&x<b&&(x=b,T=y),9===b&&(T=y,x=b)}null!==T&&(e.status="building",e.buildTarget=T,e.finalTarget=[e.me.x,e.me.y])}}}if("building"===e.status){e.me.turn>1&&e.castleTalk(e.miningIndex+77);if(null!==(C=e.getRobot(a[e.buildTarget[1]][e.buildTarget[0]]))&&C.unit===SPECS.CHURCH)e.status="goingToDeposit";else{if(e.me.x!==e.finalTarget[0]||e.me.y!==e.finalTarget[1])return s=e.navigate(e.finalTarget),{action:s};F=base.rel(e.me.x,e.me.y,e.buildTarget[0],e.buildTarget[1]);if(e.fuel+e.me.fuel>=300&&e.karbonite+e.me.karbonite>=75){if(e.status="goingToDeposit",e.knownStructures[i].length){D=e.knownStructures[i][0].x,v=e.knownStructures[i][0].y,c=e.compressLocation(D,v),S=33099;e.signal(S+c,2)}return{action:e.buildUnit(SPECS.CHURCH,F.dx,F.dy)}}var ae=e.getRobot(a[e.finalTarget[1]][e.finalTarget[0]]);null!==ae&&ae.team===e.me.team&&ae.unit===SPECS.PILGRIM&&e.me.id!==ae.id&&(e.status="goingToDeposit")}}return"goingToDeposit"===e.status&&0===qmath.dist(e.me.x,e.me.y,e.finalTarget[0],e.finalTarget[1])&&(e.status="mineHere"),!0!==n[e.me.y][e.me.x]||"mineHere"!==e.status&&"goingToKarbDeposit"!==e.status&&"mineKarb"!==e.status&&"building"!==e.status&&"goingToAnyDeposit"!==e.status?!0!==t[e.me.y][e.me.x]||"mineHere"!==e.status&&"goingToFuelDeposit"!==e.status&&"mineFuel"!==e.status&&"goingToAnyDeposit"!==e.status&&"building"!==e.status?null!==l?{action:l}:(s=e.navigate(e.finalTarget),{action:s}):(s=e.mine(),e.miningIndex=getIndexAllSpots(e,[e.me.x,e.me.y]),"building"!==e.status&&(e.status="mineFuel",e.me.turn>1&&e.castleTalk(e.miningIndex+77)),{action:s}):(s=e.mine(),e.miningIndex=getIndexAllSpots(e,[e.me.x,e.me.y]),"building"!==e.status&&(e.status="mineKarb",e.me.turn>1&&e.castleTalk(e.miningIndex+77)),{action:s})}function numberOfDeposits(e,t,n,a=false){for(var i=search.circle(e,t,n,2),s=0,r=e.getVisibleRobotMap(),o=e.getFuelMap(),l=e.getKarboniteMap(),u=0;u<i.length;u++){var g=i[u][0],m=i[u][1];if(!0===o[m][g]||!0===l[m][g])if(!1===a)s+=1;else{for(var f=search.circle(e,g,m,2),c=!0,p=0;p<f.length;p++){var S=f[p][0],h=f[p][1],d=e.getRobot(r[h][S]);null===d||d.team!==e.me.team||d.unit!==SPECS.CASTLE&&d.unit!==SPECS.CHURCH||(c=!1)}!0===c&&(s+=1)}}return s}function safeDeposit(e,t,n){if(ownHalf(e,t,n))return!0;e.getVisibleRobotMap();var a=search.unitsInRadius(e,64,e.me.team,t,n);if(a[SPECS.PROPHET].length+a[SPECS.PREACHER].length>=1)return!0;var i=search.findNearestStructure(e);return qmath.dist(t,n,i.x,i.y)<=9}function ownHalf(e,t,n){var a=e.map,i=a.length;if(e.mapIsHorizontal){if(e.lowerHalf){if(n<i/2)return!0}else if(n>=i/2)return!0}else if(e.lowerHalf){if(t<a[0].length/2)return!0}else if(t>=a[0].length/2)return!0;return!1}function canBuild(e,t,n,a,i){return!(!search.inArr(t,n,a)||0!==a[n][t]||!0!==i[n][t])}function getIndexAllSpots(e,t){for(var n=0;n<e.allSpots.length;n++){var a=e.allSpots[n];if(a.x===t[0]&&a.y===t[1])return n}return!1}export default {mind};